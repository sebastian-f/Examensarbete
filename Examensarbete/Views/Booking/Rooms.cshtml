@using Examensarbete.Models
@model Examensarbete.Models.MakeBooking
@{
    ViewBag.Title = "Rooms";
}

<style>
    th,td{
        padding:7px;
    }
</style>

<h2>Välj rum</h2>
<br />

Checkin:
@Model.CheckInDate.ToShortDateString()
<br />
Checkut:
@Model.CheckOutDate.ToShortDateString()

<br /><br />

<table>
    <tr><th><h4>Typ</h4></th><th><h4>Antal</h4></th><th><h4>Pris per rum<br />och vistelse</h4></th><th style="text-align:right">Totalt</th></tr>
@using(Html.BeginForm())
{
    for (int i = 0; i < Model.RoomCategories.Count;i++ )
    { 
        <tr><td>
        @Html.HiddenFor(m=>m.RoomCategories[i].CategoryId)
        <button type="button" class="btn btn-primary btn-xs" onclick="categoryInfo(@Model.RoomCategories[i].CategoryId)" data-toggle="modal" data-target="#myModal">@Model.RoomCategories[i].Name</button>

            </td><td>
        @Html.TextBoxFor(m => m.RoomCategories[i].NumberOfRooms, new {@class="form-control", id=Model.RoomCategories[i].CategoryId, onchange = "countSum(this,"+ Model.RoomCategories[i].PriceForChoosenDates + ")" }) 
            </td>
            <td>
                @Html.Label(Model.RoomCategories[i].PriceForChoosenDates.ToString()) kr
            </td>
            <td style="text-align:right">
                <span id="sumCat@(Model.RoomCategories[i].CategoryId)">0</span> kr
            </td>
        </tr>
    }
    <tr><td></td><td></td><td></td><td style="text-align:right"><span id="totalSum">0</span> kr</td></tr>
    <tr><td></td><td></td><td></td><td style="text-align:right"><input type="submit" value="Nästa" class="btn btn-info"/></td></tr>
}

    </table>
<br />
<span style="color:darkred">
    @ViewBag.ErrorMessage
</span>
<br /><br />
@Html.ActionLink("Tillbaka","Index")



<div id="myModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title" id="modalTitle">@Model.RoomCategories.FirstOrDefault().Name</h4>
                </div>
                <div class="modal-body" id="modalContent">

                    


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" style="float:left" data-dismiss="modal">Avbryt</button>
                    <input value="Spara" type="submit" class="btn btn-primary">

                </div>
            </div>
        
    </div>
</div>



<script>
    var categories = [];
    var imgs = [];
    @foreach(RoomCategory category in Model.RoomCategories)
    {
        <text>
            imgs = [];
            imgs[0] = new Image();
            imgs[0].src = "@Url.Action("GetImage", "Booking", new { categoryId=category.CategoryId})";
            categories.push({ id: "@category.CategoryId", name: "@category.Name", allImgs: imgs });
    </text>
    }

    function categoryInfo(categoryId) {
        var category = findCategoryById(categoryId);
        document.getElementById("modalTitle").innerHTML = category.name;
        document.getElementById("modalContent").innerHTML = "<img src='" + category.allImgs[0].src + "'>"
    }

    function findCategoryById(theId) {
        for (var i = 0; i < categories.length; i++) {
            if (categories[i].id == theId) return categories[i];
        }
    }

    function countSum() {

        @{var ids = Model.RoomCategories.Select(m=>m.CategoryId).ToArray();}

        var catIds = [];
        @foreach(RoomCategory category in Model.RoomCategories)
        {
            <text>
        catIds.push({ id: "@category.CategoryId", price: "@category.PriceForChoosenDates" });
        </text>
        }

        var totalSum = 0;
        var numberOfRooms = 0;
        catIds.forEach(function (cId) {
            numberOfRooms = parseInt($("#" + cId.id).val());
            $("#sumCat" + cId.id).text(numberOfRooms * cId.price);
            totalSum = totalSum + parseInt($("#sumCat" + cId.id).text());
        });

        $("#totalSum").text("Summa: " + totalSum);

    }


    function inputChange() {
        countSum();
        $('input').on('input', function () {
            countSum();
        });
    }
    window.onload = inputChange;

</script>